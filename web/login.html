<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Вход — Trellolite</title>
  <link rel="stylesheet" href="/web/styles.css" />
  <link rel="stylesheet" href="/web/auth.css" />
</head>
<body>
  <main class="auth-page">
    <section class="auth-card" role="form" aria-labelledby="loginTitle">
  <h1 id="loginTitle">Вход</h1>
  <p class="sub" id="loginSub">Добро пожаловать! Введите email и пароль, чтобы продолжить.</p>

      <div id="error" class="error" aria-live="polite" aria-hidden="true"></div>

  <form id="form" novalidate>
        <div class="field">
          <label for="email">Email</label>
          <div class="input-wrap">
            <input class="input" id="email" name="email" type="email" inputmode="email" autocomplete="email" placeholder="you@example.com" required autofocus />
          </div>
        </div>
        <div class="field">
          <label for="password">Пароль</label>
          <div class="input-wrap">
            <input class="input" id="password" name="password" type="password" autocomplete="current-password" minlength="6" placeholder="••••••••" required />
            <button type="button" id="togglePass" class="toggle-pass" aria-pressed="false" aria-label="Показать пароль">Показать</button>
          </div>
        </div>
        <div class="actions actions-primary">
          <button class="btn primary" id="btnLogin" type="submit">Войти</button>
          <button type="button" class="btn primary" id="btnGithub" hidden>
            <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="margin-right:6px"><path d="M12 .5a12 12 0 0 0-3.79 23.39c.6.11.82-.26.82-.58v-2.02c-3.34.73-4.04-1.61-4.04-1.61-.55-1.41-1.35-1.79-1.35-1.79-1.1-.74.08-.73.08-.73 1.22.08 1.86 1.25 1.86 1.25 1.08 1.85 2.83 1.31 3.52 1 .11-.78.42-1.31.76-1.61-2.66-.3-5.46-1.33-5.46-5.93 0-1.31.47-2.38 1.24-3.22-.12-.3-.54-1.52.12-3.17 0 0 1.01-.32 3.3 1.23a11.45 11.45 0 0 1 6 0c2.29-1.55 3.3-1.23 3.3-1.23.66 1.65.24 2.87.12 3.17.77.84 1.24 1.91 1.24 3.22 0 4.61-2.8 5.62-5.47 5.92.43.37.81 1.1.81 2.22v3.29c0 .32.22.69.82.58A12 12 0 0 0 12 .5Z"/></svg>
            Войти через GitHub
          </button>
          <button type="button" class="btn primary" id="btnGoogle" hidden>
            <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="margin-right:6px"><path d="M12 12v3.6h5.1c-.2 1.3-1.5 3.8-5.1 3.8-3.1 0-5.7-2.6-5.7-5.8s2.5-5.8 5.7-5.8c1.7 0 2.8.7 3.4 1.3l2.3-2.2C16.3 5.7 14.3 4.8 12 4.8 7.6 4.8 4 8.4 4 12.8s3.6 8 8 8c4.6 0 7.7-3.2 7.7-7.7 0-.5 0-.8-.1-1.1H12z"/></svg>
            Войти через Google
          </button>
        </div>
        <div class="actions actions-secondary">
          <a class="btn" href="/web/register.html" role="button" aria-label="Перейти к регистрации">Регистрация</a>
          <button type="button" id="btnForgot" class="btn">Забыли пароль?</button>
        </div>
        <div class="form-footer">
          <a href="/privacy" rel="nofollow">Политика конфиденциальности</a>
        </div>
      </form>

      <form id="formReset" novalidate hidden>
        <div class="field">
          <label for="newpass">Новый пароль</label>
          <div class="input-wrap">
            <input class="input" id="newpass" name="newpass" type="password" autocomplete="new-password" minlength="6" placeholder="Минимум 6 символов" required />
          </div>
        </div>
        <div class="field">
          <label for="newpass2">Повторите пароль</label>
          <div class="input-wrap">
            <input class="input" id="newpass2" name="newpass2" type="password" autocomplete="new-password" minlength="6" placeholder="Ещё раз" required />
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" id="btnDoReset" type="submit">Сменить пароль</button>
          <button class="btn primary" id="btnBackToLogin" type="button">Отмена</button>
        </div>
        <div class="helper small">
          <span>Вы используете dev magic‑link. Проверьте URL (#reset=...).</span>
        </div>
      </form>
    </section>
  </main>

  <script>
    const qs = (s) => document.querySelector(s);
    const errorBox = qs('#error');
    function showError(msg){ errorBox.textContent = msg; errorBox.setAttribute('aria-hidden','false'); }
    function clearError(){ errorBox.textContent = ''; errorBox.setAttribute('aria-hidden','true'); }
    function emailValid(v){ return /.+@.+\..+/.test(v); }

    async function ensureNotLoggedIn(){
      try {
        // Skip check if we're navigating to register or already there
        if (location.pathname.includes('register.html') || 
            localStorage.getItem('navigatingToRegister') ||
            sessionStorage.getItem('navigatingToRegister')) {
          console.log('Skipping auth check - navigating to/at register');
          return;
        }
        
        const r = await fetch('/api/auth/me', { credentials:'include' });
        if (r.ok) {
          const data = await r.json().catch(()=>null);
          if (data && data.user) { location.replace('/'); }
        }
      } catch(e) {
        console.warn('ensureNotLoggedIn failed:', e);
      }
    }

    function startAuthWatcher(){
      let tries = 0;
      const maxTries = 30; // ~15-20 секунд с бэк-оффом
      let delay = 500;
      const tick = async () => {
        tries++;
        await ensureNotLoggedIn();
        if (tries >= maxTries) return;
        delay = Math.min(2000, delay + 250);
        setTimeout(tick, delay);
      };
      tick();
    }

    function togglePassword(){
      const inp = qs('#password');
      const btn = qs('#togglePass');
      const show = inp.type === 'password';
      inp.type = show ? 'text' : 'password';
      btn.setAttribute('aria-pressed', String(show));
      btn.textContent = show ? 'Скрыть' : 'Показать';
    }

  async function onSubmit(e){
      e.preventDefault();
      clearError();
      const email = qs('#email').value.trim();
      const password = qs('#password').value;
      if (!emailValid(email)) return showError('Укажите корректный email.');
      if (!password || password.length < 6) return showError('Пароль должен быть не короче 6 символов.');

      const btn = qs('#btnLogin');
      const prev = btn.textContent;
      btn.textContent = 'Входим…';
      btn.disabled = true;
      try {
        const res = await fetch('/api/auth/login', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ email, password })
        });
        if (!res.ok){
          let msg = 'Ошибка входа';
          try { const data = await res.json(); if (data && data.error) msg = data.error; } catch {}
          throw new Error(msg);
        }
        location.replace('/');
      } catch (err){
        showError(err.message || 'Ошибка сети');
      } finally {
        btn.disabled = false; btn.textContent = prev;
      }
    }

    async function sendReset(){
      clearError();
      const email = qs('#email').value.trim();
      if (!emailValid(email)) return showError('Укажите корректный email.');
      try {
        const res = await fetch('/api/auth/reset', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email }) });
        if (!res.ok) throw new Error('Не удалось отправить ссылку');
        showError('Если такой email существует, ссылка на сброс сгенерирована (dev: см. логи сервера).');
      } catch (e){ showError(e.message || 'Ошибка'); }
    }

    function parseHash(){
      const h = location.hash || '';
  const m1 = h.match(/#reset=([^&]+)/);
  const m2 = h.match(/#verify=([^&]+)/);
  return { reset: m1 ? decodeURIComponent(m1[1]) : '', verify: m2 ? decodeURIComponent(m2[1]) : '' };
    }

    function switchToResetMode(on){
      qs('#form').hidden = on;
      qs('#formReset').hidden = !on;
      qs('#loginSub').textContent = on ? 'Смена пароля' : 'Добро пожаловать! Введите email и пароль, чтобы продолжить.';
    }

  async function onResetSubmit(e){
      e.preventDefault(); clearError();
  const { reset: t } = parseHash(); if (!t) return showError('Токен не найден в URL.');
      const p1 = qs('#newpass').value, p2 = qs('#newpass2').value;
      if (!p1 || p1.length < 6) return showError('Пароль должен быть не короче 6 символов.');
      if (p1 !== p2) return showError('Пароли не совпадают.');
      const btn = qs('#btnDoReset'); const prev = btn.textContent; btn.disabled = true; btn.textContent = 'Сохраняем…';
      try {
        const r = await fetch('/api/auth/reset/confirm', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token: t, new_password: p1 }) });
        if (!r.ok) throw new Error('Не удалось сменить пароль');
        showError('Пароль изменён. Теперь можно войти.');
        setTimeout(()=>{ location.hash=''; switchToResetMode(false); }, 800);
      } catch(e){ showError(e.message || 'Ошибка'); } finally { btn.disabled=false; btn.textContent = prev; }
    }

    document.addEventListener('DOMContentLoaded', () => {
      ensureNotLoggedIn();
      qs('#form').addEventListener('submit', onSubmit);
      qs('#togglePass').addEventListener('click', togglePassword);
      qs('#btnForgot').addEventListener('click', sendReset);
      qs('#formReset').addEventListener('submit', onResetSubmit);
      qs('#btnBackToLogin').addEventListener('click', ()=>{ location.hash=''; switchToResetMode(false); });
      
      // Prevent auto-redirects when navigating to register
      const registerLink = qs('a[href="/web/register.html"]');
      if (registerLink) {
        registerLink.addEventListener('click', (e) => {
          try { 
            localStorage.setItem('navigatingToRegister', 'true');
            sessionStorage.setItem('navigatingToRegister', 'true');
            console.log('Set navigatingToRegister flag'); 
          } catch(e) { 
            console.warn('Storage not available:', e); 
          }
        });
      }
      // Discover providers
  fetch('/api/auth/providers').then(r=>r.json()).then(data=>{
        if(data && Array.isArray(data.providers)){
          const hasGithub = data.providers.some(p=>p.id==='github');
          if(hasGithub){
    const gh = qs('#btnGithub'); gh.hidden = false;
    gh.addEventListener('click', ()=>{
              try { localStorage.setItem('oauthFlow','github'); } catch {}
              location.href = '/api/auth/oauth/github/start';
            });
          }
          const hasGoogle = data.providers.some(p=>p.id==='google');
          if(hasGoogle){
            const gg = qs('#btnGoogle'); gg.hidden = false;
            gg.addEventListener('click', ()=>{
              try { localStorage.setItem('oauthFlow','google'); } catch {}
              location.href = '/api/auth/oauth/google/start';
            });
          }
        }
      }).catch(()=>{});

      // If magic reset token in URL, switch UI
      const ph = parseHash();
      if (ph.reset) switchToResetMode(true);
      // If verify token present, confirm and then suggest login
      if (ph.verify){
        fetch('/api/auth/verify/confirm', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token: ph.verify }) })
          .then(r=>r.json().catch(()=>({})))
          .then(()=>{ showError('Email подтверждён. Теперь можно войти.'); location.hash=''; })
          .catch(()=>{ showError('Не удалось подтвердить email.'); });
      }
      // If we return from OAuth flow or just in case, start watcher and also react on focus
      // BUT: only if we're still on login page, not transitioning to register
      try { 
        const hasOAuth = localStorage.getItem('oauthFlow');
        const isNavigating = localStorage.getItem('navigatingToRegister');
        console.log('Login init - oauthFlow:', hasOAuth, 'navigating:', isNavigating);
        if (hasOAuth && !isNavigating) { 
          startAuthWatcher(); 
          localStorage.removeItem('oauthFlow'); 
        } 
      } catch(e) { 
        console.warn('localStorage check failed:', e); 
      }
      // Only watch focus if not navigating to register
      window.addEventListener('focus', () => {
        try {
          const isNavigating = localStorage.getItem('navigatingToRegister');
          console.log('Focus event - navigating:', isNavigating);
          if (!isNavigating) {
            ensureNotLoggedIn();
          }
        } catch(e) {
          console.warn('Focus check failed:', e);
          // Fallback: don't check auth on focus if localStorage fails
        }
      });
    });
  </script>
</body>
</html>
