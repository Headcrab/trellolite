<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Карточка — общий доступ</title>
  <link rel="icon" type="image/png" href="/web/favicon.png" sizes="32x32">
  <script src="/web/i18n/i18n.js" defer></script>
  <style>
    :root{ --bg: #0b0c0f; --fg: #e5e7eb; --muted:#9aa0a6; --card:#111827; --accent:#3b82f6; }
    html[data-theme="light"] { --bg: #f6f7fb; --fg:#111827; --muted:#6b7280; --card:#ffffff; --accent:#2563eb; }
    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    .wrap{max-width:900px;margin:0 auto;padding:24px;}
    header{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
    header h1{font-size:18px;margin:0;}
    header .spacer{flex:1;}
    .card{background:var(--card);border-radius:10px;border:1px solid rgba(255,255,255,.08);padding:16px 18px;box-shadow:0 4px 14px rgba(0,0,0,.18)}
    .title{font-weight:600;font-size:18px;margin:0 0 6px 0}
    .desc{white-space:pre-wrap}
    .meta{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:12px;margin:10px 0 0}
    .badge{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.06);padding:2px 8px;border-radius:999px}
    .badge .dot{width:8px;height:8px;border-radius:50%}
    .muted{color:var(--muted)}
    .footer{margin-top:20px;color:var(--muted);font-size:12px}
    .brand{display:inline-flex;gap:8px;align-items:center;color:var(--muted);text-decoration:none}
    .brand svg{width:18px;height:18px;opacity:.85}
  #btnTheme svg{width:18px;height:18px;opacity:.85}
    .error{padding:12px 14px;border:1px solid #ef4444;background:rgba(239,68,68,.08);color:#ef9a9a;border-radius:8px}
    .color{display:inline-flex;gap:8px;align-items:center}
  .comments{margin-top:14px;border-top:1px dashed rgba(255,255,255,.12);padding-top:12px}
  .comments h3{margin:0 0 8px 0;font-size:14px;color:var(--muted)}
  .comment{padding:8px 10px;border:1px solid rgba(255,255,255,.08);border-radius:8px;margin:8px 0;background:rgba(255,255,255,.03)}
  .comment .meta{margin:0 0 4px 0;font-size:11px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="brand" href="/" title="Trellolite">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M4 4h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm3 3v10h5V7H7zm9 0v6h3V7h-3z"/></svg>
        <span>Trellolite</span>
      </a>
      <div class="spacer"></div>
  <button id="btnTheme" title="" aria-label="" style="background:none;border:0;color:inherit;cursor:pointer">
        <svg><use href="#i-auto"></use></svg>
      </button>
    </header>

  <div id="view"></div>

  <div id="footerNote" class="footer muted" data-t="app.share.footer">Публичная страница. Данные доступны только по ссылке.</div>
  </div>

  <svg style="display:none">
    <symbol id="i-auto" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3a9 9 0 1 0 9 9h-9V3Z"/></symbol>
    <symbol id="i-sun" viewBox="0 0 24 24"><path fill="currentColor" d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.79 1.8-1.79zm10.48 0l1.79-1.79 1.79 1.79-1.79 1.79-1.79-1.79zM12 1h0v3h0V1zm0 19h0v3h0v-3zM4.84 17.24l-1.79 1.79 1.79 1.79 1.79-1.79-1.79-1.79zm14.32 0l1.79 1.79-1.79 1.79-1.79-1.79 1.79-1.79zM1 12h3v0H1v0zm19 0h3v0h-3v0zM12 6a6 6 0 100 12A6 6 0 0012 6z"/></symbol>
    <symbol id="i-moon" viewBox="0 0 24 24"><path fill="currentColor" d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"/></symbol>
  </svg>

  <script>
  function tt(key, def){
    try{
      if(typeof t==='function'){
        const v = t(key);
        if(v && v !== key) return v; // use translation only if it differs from the key
      }
    }catch{}
    return def;
  }
  function getPreferredTheme(){ try{ const s=localStorage.getItem('theme'); if(s==='light'||s==='dark'||s==='auto') return s; }catch{} return 'auto'; }
  function setTheme(mode){ const html=document.documentElement; if(mode==='auto'){ html.removeAttribute('data-theme'); } else { html.setAttribute('data-theme', mode); } const use=document.querySelector('#btnTheme use'); if(use){ use.setAttribute('href', mode==='dark'?'#i-moon': mode==='light'?'#i-sun':'#i-auto'); }
  }
  (function(){ const btn=document.getElementById('btnTheme'); if(btn){ btn.addEventListener('click', ()=>{ const cur=getPreferredTheme(); const next = cur==='auto'?'light':cur==='light'?'dark':'auto'; localStorage.setItem('theme', next); setTheme(next); }); setTheme(getPreferredTheme()); btn.title = tt('app.theme.toggle','Тема'); btn.setAttribute('aria-label', btn.title); } })();
  async function fetchJSON(url){ const res = await fetch(url); if(!res.ok){ throw new Error(await res.text()||res.statusText); } try{ return await res.json(); }catch{ return null; } }
  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
  function renderMd(s){
    // simple but nicer Markdown: headings, lists, links, code, paragraphs
    const esc = (t)=> (t||'').replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    const inline = (t)=>{
      let x = t||'';
      const slots=[]; // code spans
      x = x.replace(/`([^`]+)`/g,(m,g)=>{ slots.push(esc(g)); return `\u0001C${slots.length-1}\u0002`; });
      x = esc(x);
      x = x.replace(/\*\*([^*]+)\*\*/g,'<strong>$1<\/strong>');
      x = x.replace(/(^|[^*])\*([^*]+)\*(?=[^*]|$)/g,'$1<em>$2<\/em>');
      x = x.replace(/\[([^\]]+)\]\((https?:[^)\s]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1<\/a>');
      x = x.replace(/\u0001C(\d+)\u0002/g,(m,n)=>`<code>${slots[+n]||''}<\/code>`);
      return x;
    };
    const lines = (s||'').replace(/\r\n?/g,'\n').split('\n');
    const out=[]; let i=0, inCode=false, code=[]; let list=null, buf=[];
    const flushP=()=>{ if(buf.length){ out.push('<p>'+inline(buf.join(' '))+'<\/p>'); buf=[]; } };
    const flushList=()=>{ if(list){ out.push('<'+list.tag+'>'+list.items.join('')+'<\/'+list.tag+'>'); list=null; } };
    while(i<lines.length){
      const ln=lines[i];
      const fence=/^\s*```\s*([\w-]*)\s*$/.exec(ln);
      if(fence){ if(!inCode){ inCode=true; code=[]; i++; continue; } out.push('<pre><code>'+esc(code.join('\n'))+'<\/code><\/pre>'); inCode=false; i++; continue; }
      if(inCode){ code.push(ln); i++; continue; }
      if(/^\s*$/.test(ln)){ flushP(); flushList(); i++; continue; }
      const h=/^\s{0,3}(#{1,6})\s+(.+)$/.exec(ln); if(h){ flushP(); flushList(); const lvl=h[1].length; out.push('<h'+lvl+'>'+inline(h[2])+'<\/h'+lvl+'>'); i++; continue; }
      let m;
      if((m=/^\s*[-*]\s+(.+)$/.exec(ln))){ if(!list||list.tag!=='ul'){ flushP(); flushList(); list={tag:'ul',items:[]}; } list.items.push('<li>'+inline(m[1])+'<\/li>'); i++; continue; }
      if((m=/^\s*\d+[.)]\s+(.+)$/.exec(ln))){ if(!list||list.tag!=='ol'){ flushP(); flushList(); list={tag:'ol',items:[]}; } list.items.push('<li>'+inline(m[1])+'<\/li>'); i++; continue; }
      buf.push(ln.trim()); i++;
    }
    flushP(); flushList();
    return out.join('\n');
  }
  async function main(){
    const token = location.pathname.split('/').pop();
    const view = document.getElementById('view');
    view.innerHTML = '<div class="muted">'+tt('profile.loading','Загрузка…')+'</div>';
    try{
  const payload = await fetchJSON('/api/public/share/'+encodeURIComponent(token));
  const c = payload && payload.card ? payload.card : payload; // backward compat if server returns bare card
  const comments = payload && payload.comments ? payload.comments : [];
      try{ if(window.i18n){ i18n.apply(); } }catch{}
      try{ document.title = tt('app.share.page_title','Карточка — общий доступ'); document.getElementById('footerNote').textContent = tt('app.share.footer','Публичная страница. Данные доступны только по ссылке.'); }catch{}
      const color = (c && c.color) ? c.color : '';
  const due = c && c.due_at ? new Date(c.due_at).toLocaleString() : '';
  const assignee = c && c.assignee ? String(c.assignee) : '';
      const descHtml = (c.description_is_md ? renderMd(c.description||'') : ('<p>'+escapeHTML(c.description||'').replace(/\n/g,'<br>')+'</p>'));
      let html = '<article class="card"'+(color?(' style="--clr:'+color+'; border-left:6px solid '+color+'"'):'')+'>'+
        '<h2 class="title">'+escapeHTML(c.title||'')+'</h2>'+
        (c.description?('<div class="desc">'+descHtml+'</div>'):'')+
        '<div class="meta">'+
          (assignee?('<span class="badge" title="'+escapeHTML(tt('app.dialogs.card.assignee','Исполнитель'))+'">'+
                       '<svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-1c0-2.76-3.58-5-8-5Z"/></svg>'+
                       '<span>'+escapeHTML(assignee)+'</span>'+
                     '</span>'):'')+
          (due?('<span class="badge"><span class="dot" style="background:'+color+'"></span>'+escapeHTML(due)+'</span>'):'')+
        '</div>'+
      '</article>';
      // comments
      if(Array.isArray(comments)){
        const items = comments.map(cm=>{
          const ts = cm.created_at ? new Date(cm.created_at).toLocaleString() : '';
          const author = cm.author || '';
          // support simple md in comments too
          const body = renderMd(cm.body||'');
          return '<div class="comment">'+
                   ((ts||author)?('<div class="meta muted">'+escapeHTML([ts, author].filter(Boolean).join(' · '))+'</div>'):'')+
                   '<div class="body">'+body+'</div>'+
                 '</div>';
        }).join('');
        const title = tt('app.dialogs.card.comments','Комментарии');
        html += '<section class="comments">'+
                  '<h3>'+escapeHTML(title)+'</h3>'+
                  (items||('<div class="muted">'+escapeHTML(tt('app.share.no_comments','Нет комментариев'))+'</div>'))+
                '</section>';
      }
      view.innerHTML = html;
    }catch(err){ view.innerHTML = '<div class="error">'+tt('app.share.not_found','Ссылка недоступна или удалена.')+'</div>'; }
  }
  main();
  </script>
</body>
</html>
